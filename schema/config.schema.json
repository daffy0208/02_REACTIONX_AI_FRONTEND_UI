{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://reactionx.metis/schema/config.schema.json",
  "title": "ReactionX / Metis Coach Console – Configuration Contract",
  "description": "Schema v0.2.0 for validating light drill configurations generated by the Coach Console.",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "0.2.0",
      "description": "Contract version. Must be exactly '0.2.0'."
    },
    "id": {
      "type": "string",
      "description": "Unique identifier for this configuration (UUID or slug)."
    },
    "name": {
      "type": "string",
      "description": "Human‑readable drill name/title."
    },
    "mode": {
      "type": "string",
      "description": "Selected operating mode for the lights.",
      "enum": [
        "Standard",
        "AllAtOnce",
        "Sequence",
        "TrueFalse",
        "Focus",
        "FindDifference",
        "Command",
        "Battle",
        "ColorBattle",
        "ColorBattle2"
      ]
    },
    "hardware": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "numLamps": {
          "type": "integer",
          "minimum": 1,
          "maximum": 12,
          "description": "Number of active lamps in the drill."
        },
        "lampIds": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional stable identifiers for lamps (BLE MAC, alias, etc.)."
        }
      }
    },
    "parameters": {
      "type": "object",
      "description": "Mode‑specific parameters. Per‑mode constraints are applied via conditional rules below."
    },
    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional hard limits to respect (coach preferences / facility constraints).",
      "properties": {
        "durationSec": { "type": "number", "minimum": 1, "maximum": 3600 },
        "maxRounds": { "type": "integer", "minimum": 1, "maximum": 100 }
      }
    },
    "notes": { "type": "string" }
  },
  "required": ["schemaVersion", "mode", "parameters"],
  "allOf": [
    {
      "if": { "properties": { "mode": { "const": "Standard" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "colors": { "$ref": "#/$defs/colorArray" },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 },
              "delaySec": { "type": "number", "minimum": 0, "maximum": 10 },
              "rounds": { "type": "integer", "minimum": 1, "maximum": 20 },
              "startDelaySec": { "type": "number", "minimum": 0, "maximum": 10 },
              "speed": { "$ref": "#/$defs/speed" }
            },
            "required": ["numLamps", "colors", "timeoutSec"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "AllAtOnce" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "colors": { "$ref": "#/$defs/colorArray" },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 },
              "simultaneous": { "type": "integer", "minimum": 1, "maximum": 12, "description": "How many lamps light at once." },
              "rounds": { "type": "integer", "minimum": 1, "maximum": 20 }
            },
            "required": ["numLamps", "colors", "timeoutSec", "simultaneous"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "Sequence" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "colors": { "$ref": "#/$defs/colorArray" },
              "sequenceLength": { "type": "integer", "minimum": 1, "maximum": 100 },
              "order": { "type": "string", "enum": ["random", "leftToRight", "rightToLeft", "custom"] },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 },
              "delaySec": { "type": "number", "minimum": 0, "maximum": 10 }
            },
            "required": ["numLamps", "colors", "sequenceLength", "order"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "TrueFalse" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "trueColor": { "$ref": "#/$defs/color" },
              "falseColor": { "$ref": "#/$defs/color" },
              "probabilityTrue": { "type": "number", "minimum": 0, "maximum": 100, "description": "Probability of TRUE (correct) color in %." },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["numLamps", "trueColor", "falseColor", "probabilityTrue"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "Focus" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "targetColors": { "$ref": "#/$defs/colorArray" },
              "distractorColors": { "$ref": "#/$defs/colorArray" },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["numLamps", "targetColors"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "FindDifference" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "colors": { "$ref": "#/$defs/colorArray" },
              "difficulty": { "type": "string", "enum": ["easy", "medium", "hard"] },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["numLamps", "colors", "difficulty"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "Command" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "numLamps": { "type": "integer", "minimum": 1, "maximum": 12 },
              "promptSet": { "type": "string", "description": "Identifier for the command set shown on phone screen." },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["numLamps", "promptSet"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "Battle" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "players": { "type": "integer", "minimum": 2, "maximum": 2 },
              "scoreTarget": { "type": "integer", "minimum": 1, "maximum": 50 },
              "colors": { "$ref": "#/$defs/twoColors" },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["players", "scoreTarget", "colors"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "ColorBattle" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "players": { "type": "integer", "minimum": 2, "maximum": 2 },
              "teamAColor": { "$ref": "#/$defs/color" },
              "teamBColor": { "$ref": "#/$defs/color" },
              "rounds": { "type": "integer", "minimum": 1, "maximum": 20 },
              "timeoutSec": { "type": "number", "minimum": 0.5, "maximum": 5 }
            },
            "required": ["players", "teamAColor", "teamBColor"]
          }
        }
      }
    },
    {
      "if": { "properties": { "mode": { "const": "ColorBattle2" } } },
      "then": {
        "properties": {
          "parameters": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "players": { "type": "integer", "minimum": 2, "maximum": 2 },
              "teamAColor": { "$ref": "#/$defs/color" },
              "teamBColor": { "$ref": "#/$defs/color" },
              "fastestGetsPoint": { "type": "boolean", "const": true },
              "rounds": { "type": "integer", "minimum": 1, "maximum": 20 }
            },
            "required": ["players", "teamAColor", "teamBColor", "fastestGetsPoint"]
          }
        }
      }
    }
  ],
  "$defs": {
    "speed": {
      "type": "string",
      "enum": ["slow", "medium", "fast"]
    },
    "color": {
      "description": "Named color or hex code.",
      "anyOf": [
        { "type": "string", "enum": ["Red", "Blue", "Green", "Yellow", "Purple", "Orange", "White"] },
        { "type": "string", "pattern": "^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$" }
      ]
    },
    "colorArray": {
      "type": "array",
      "minItems": 1,
      "maxItems": 12,
      "uniqueItems": true,
      "items": { "$ref": "#/$defs/color" }
    },
    "twoColors": {
      "type": "array",
      "minItems": 2,
      "maxItems": 2,
      "uniqueItems": true,
      "items": { "$ref": "#/$defs/color" }
    }
  },
  "examples": [
    {
      "schemaVersion": "0.2.0",
      "name": "True/False – 70% True",
      "mode": "TrueFalse",
      "hardware": { "numLamps": 4 },
      "parameters": {
        "numLamps": 4,
        "trueColor": "Red",
        "falseColor": "Green",
        "probabilityTrue": 70,
        "timeoutSec": 1.5
      }
    },
    {
      "schemaVersion": "0.2.0",
      "name": "Battle – to 10",
      "mode": "Battle",
      "parameters": {
        "players": 2,
        "scoreTarget": 10,
        "colors": ["Red", "Blue"],
        "timeoutSec": 1.0
      }
    }
  ]
}


